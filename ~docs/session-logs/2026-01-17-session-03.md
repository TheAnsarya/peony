# Peony Session Log - 2026-01-17 Session 03

## Session Summary
Implemented SNES platform support with full 65816 CPU decoder. Closes GitHub issue #30.

## Work Completed

### 65816 CPU Decoder (`Peony.Cpu.65816`)
- Full 65816 opcode table with all addressing modes:
	- Standard 6502 modes (immediate, zero page, absolute, etc.)
	- 65816-specific modes: long addressing (24-bit), stack-relative, block move
	- Direct indirect long (`[$nn]`), stack relative indirect Y (`($nn,s),y`)
- Variable-width register support:
	- `AccumulatorIs8Bit` - M flag for 8/16-bit accumulator
	- `IndexIs8Bit` - X flag for 8/16-bit index registers
	- Instruction length changes dynamically based on flags
- All 65816 instructions including:
	- Long jumps/calls: `jml`, `jsl`, `rtl`, `brl`
	- Register width: `sep`, `rep`
	- Block moves: `mvn`, `mvp`
	- Stack operations: `pea`, `pei`, `per`, `phb`, `plb`, `phd`, `pld`, `phk`
	- Exchange: `xba`, `xce`

### SNES Platform Analyzer (`Peony.Platform.SNES`)
- ROM mapping mode detection:
	- LoRom (Mode 20) - 32KB banks at $8000-$FFFF
	- HiRom (Mode 21) - 64KB banks
	- ExLoRom (Mode 25) - Extended LoRom for >4MB ROMs
	- ExHiRom (Mode 26) - Extended HiRom for >4MB ROMs
- Copier header detection (512-byte SMC headers)
- Address mapping functions:
	- `AddressToOffset()` with proper bank handling
	- Memory region identification
- Hardware register labels:
	- PPU registers ($2100-$213F): INIDISP, BGMODE, VMAIN, etc.
	- APU registers ($2140-$2143): APUIO0-3
	- CPU registers ($4200-$421F): NMITIMEN, RDNMI, JOY1L, etc.
	- DMA registers ($4300-$437A): Dynamic labels (DMAP0, BBAD0, etc.)
	- WRAM registers ($2180-$2183): WMDATA, WMADDL, etc.
- Entry point detection from reset/NMI/IRQ vectors

### Test Suite (38 new tests)
- **Cpu65816DecoderTests** (25 tests):
	- NOP, LDA immediate (8/16-bit), LDX immediate (8/16-bit)
	- JSL/JML long addressing
	- BRL relative long branching
	- SEP/REP register width instructions
	- MVN/MVP block move
	- Direct indirect long, stack relative addressing
	- PEA, PHB, PLB, XBA, XCE
	- Control flow detection
	- Target address calculation for JSL/JML
- **SnesAnalyzerTests** (13 tests):
	- Platform/decoder identity
	- Register labels (PPU, APU, CPU, DMA)
	- Memory region classification
	- LoRom address mapping
	- Copier header detection
	- Entry point extraction

### CLI Integration
- Added SNES platform support to CLI (`--platform snes`)
- Tested with real FFMQ ROM and DIZ file
- Successfully disassembles SNES ROMs with labels

## Test Results
All 62 tests passing:
- 24 original tests (CDL, DIZ, DisassemblyEngine)
- 25 new 65816 CPU tests
- 13 new SNES platform tests

## Files Created/Changed
- `src/Peony.Cpu.65816/Peony.Cpu.65816.csproj` - New project file
- `src/Peony.Cpu.65816/Cpu65816Decoder.cs` - Full 65816 decoder (~550 lines)
- `src/Peony.Platform.SNES/Peony.Platform.SNES.csproj` - New project file
- `src/Peony.Platform.SNES/SnesAnalyzer.cs` - SNES platform (~400 lines)
- `src/Peony.Cli/Peony.Cli.csproj` - Added SNES references
- `src/Peony.Cli/Program.cs` - Added SNES platform support
- `tests/Peony.Core.Tests/Peony.Core.Tests.csproj` - Added test references
- `tests/Peony.Core.Tests/Cpu65816DecoderTests.cs` - New test file
- `tests/Peony.Core.Tests/SnesAnalyzerTests.cs` - New test file
- `Peony.sln` - Added new projects

## Git Commits
- `93cedd9` - feat: Add SNES platform support with 65816 CPU decoder (Closes #30)

## GitHub Issues
- [#30](https://github.com/TheAnsarya/peony/issues/30) - **CLOSED** - Add SNES platform support for DiztinGUIsh integration

## Verified Functionality
- Disassembled FFMQ ROM with SNES platform
- Labels from DIZ file properly imported
- Hardware register labels displayed in output
- ROM header parsed correctly (name: "FF MYSTIC QUEST")
- 16 banks detected for 512KB ROM

## Next Steps
1. Implement issue #31: Bank-specific label propagation
2. Add Game Boy platform support
3. Improve SNES disassembly starting from reset vector
4. Track SEP/REP instructions to dynamically update register widths
5. Add more comprehensive SNES ROM tests with known-good output
