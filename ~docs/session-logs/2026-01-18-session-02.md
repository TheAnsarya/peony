# Peony Session Log - 2026-01-18 Session 02

## Session Overview
- **Date:** January 18, 2026
- **Focus:** NES CHR Graphics Extractor and Data Table Extractor implementation
- **Duration:** Extended session

## Completed Work

### 1. NES CHR Graphics Extractor (#35)

**Core Framework (`src/Peony.Core/GraphicsExtractor.cs`):**
- `IGraphicsExtractor` interface for platform-agnostic graphics extraction
- `TileGraphics` static class with:
  - `Decode2bppPlanar()` - Converts NES-style 2bpp tiles to 8-bit indexed pixels
  - `Decode4bppPlanar()` - Converts SNES-style 4bpp tiles to 8-bit indexed pixels
  - `ArrangeTiles()` - Composites individual tiles into a tile sheet
  - `SaveAsBmp()` - BMP file output (no external dependencies)
- NES Grayscale palette (4 colors)
- Full NES PPU palette (64 colors)

**NES Implementation (`src/Peony.Platform.NES/NesChrExtractor.cs`):**
- iNES header parsing for CHR bank detection
- CHR bank extraction (8KB per bank, 512 tiles)
- Image output in BMP format (16x32 tile arrangement)
- JSON metadata generation with bank info and tile counts

**Tests (`tests/Peony.Core.Tests/NesChrExtractorTests.cs`):**
- 12 tests covering:
  - 2bpp planar tile decoding
  - Multi-tile decoding
  - Tile arrangement
  - iNES header parsing
  - CHR bank extraction
  - BMP file generation
  - PNG-like metadata output

### 2. NES Data Table Extractor (#36)

**Core Framework (`src/Peony.Core/DataTableExtractor.cs`):**
- `IDataTableExtractor` interface for platform-agnostic data extraction
- `DataTableDefinition` record defining table structure
- `FieldDefinition` record with multiple field types:
  - `Byte`, `SByte`, `Word`, `SWord`, `WordBE`, `Pointer`, `Flags`, `ByteArray`, `String`
- `DataExtraction` static class with:
  - `ReadField()` - Reads a single field from ROM data
  - `ExtractTable()` - Extracts all records from a table
  - `SaveTableAsJson()` - JSON output with configurable formatting
  - `SaveTableSchema()` - JSON Schema generation for validation

**NES Implementation (`src/Peony.Platform.NES/NesDataTableExtractor.cs`):**
- Pre-built RPG table templates:
  - `CreateMonsterTableDefinition()` - Stats, resistance, loot tables
  - `CreateItemTableDefinition()` - Equipment with stats and prices
  - `CreateSpellTableDefinition()` - Magic with effects and costs
  - `CreateExpTableDefinition()` - Experience point curves
  - `CreateShopTableDefinition()` - Shop inventory tables

**Tests (`tests/Peony.Core.Tests/NesDataTableExtractorTests.cs`):**
- 16 tests covering:
  - All field type reading (Byte, SByte, Word, SWord, WordBE, Pointer, Flags)
  - Array field extraction
  - Full table extraction
  - JSON output generation
  - JSON Schema generation
  - All 5 RPG table template validations

### 3. Test Summary
- **Previous Total:** 317 tests
- **New Tests:** 28 (12 CHR + 16 Data Table)
- **New Total:** 345 tests
- **All Tests Passing:** ✓

## Commits
1. `feat: Add NES CHR graphics and data table extractors (#35, #36)`

## GitHub Issues

### Closed This Session
- #35: NES CHR Graphics Extractor ✅
- #36: NES Data Table Extractor ✅

### Remaining from Epic #34
- #37: NES Text Extraction with TBL Support
- #38: SNES Graphics Extractor (2/4/8bpp)
- #39: GBA Graphics Extractor (4/8bpp + OAM)

## Files Created
- `src/Peony.Core/GraphicsExtractor.cs` - Core graphics extraction framework
- `src/Peony.Core/DataTableExtractor.cs` - Core data extraction framework
- `src/Peony.Platform.NES/NesChrExtractor.cs` - NES CHR extractor implementation
- `src/Peony.Platform.NES/NesDataTableExtractor.cs` - NES data table extractor with RPG templates
- `tests/Peony.Core.Tests/NesChrExtractorTests.cs` - 12 CHR extraction tests
- `tests/Peony.Core.Tests/NesDataTableExtractorTests.cs` - 16 data table tests

## Architecture Notes

### BMP vs PNG Decision
Used BMP format for image output to avoid external dependencies (no ImageSharp/SkiaSharp required). BMP is:
- Uncompressed (larger files, but trivial to implement)
- Universally readable
- Good for tile graphics editing workflows

### Field Type Design
The `DataFieldType` enum supports common ROM data patterns:
- Signed/unsigned variants for byte/word
- Big-endian for SNES/Genesis (Motorola-style)
- Pointer type for 16/24-bit addresses
- Flags for bit fields
- ByteArray for raw data blocks
- String for null-terminated or fixed-length text

## What's Next
- Implement NES Text Extraction with TBL Support (#37)
- Implement SNES Graphics Extractor (#38)
- Implement GBA Graphics Extractor (#39)
- Continue integration with Poppy's reinsertion pipeline
