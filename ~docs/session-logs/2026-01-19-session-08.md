# Session 08 - Text Encoder CLI & Platform Templates

**Date:** 2026-01-19
**Focus:** Poppy Text Encoder (#130), Platform Templates Expansion

## Summary

This session implemented the Text Encoder CLI command for Poppy and expanded text table templates across both Peony and Poppy projects.

## Completed Work

### 1. Text Encoder CLI (Poppy Issue #130)

**File:** [src/Poppy.Core/CodeGen/TextEncoder.cs](../../src/Poppy.Core/CodeGen/TextEncoder.cs)

Already had comprehensive TextEncoder class with:
- TBL file parsing
- DTE (Dual Tile Encoding) support
- Multi-byte character support
- Control codes

**Added Templates:**
- `pokemon` / `pkmn` - Pokemon Red/Blue (Game Boy)
- `dw` / `dq` / `dragonquest` - Dragon Quest (NES/SNES)
- `ff` / `finalfantasy` - Final Fantasy (NES/SNES)
- `eb` / `earthbound` / `mother` - EarthBound (SNES)

**CLI Integration** (`poppy text-encode`):
```bash
# Encode with template
poppy text-encode --template dw --text "Hello World!" -o output.bin

# Encode from file with custom table
poppy text-encode -i dialog.txt --table game.tbl -o output.bin

# Output formats: bin (default), asm, hex
poppy text-encode --template pokemon --text "HELLO" -o test.asm --format asm
```

### 2. Additional Platform Templates

Added templates for classic NES games to both Peony (TableFile) and Poppy (TextEncoder):

| Template | Aliases | Platform | Notes |
|----------|---------|----------|-------|
| Zelda | `zelda`, `loz` | NES | A-Z at $0A, includes RUPEE control |
| Metroid | `metroid` | NES | Simple uppercase alphabet |
| Castlevania | `castlevania`, `cv` | NES | A-Z at $00, end at $40 |
| Mega Man | `megaman`, `mm`, `rockman` | NES | A-Z at $00, numbers at $50 |

### 3. Issue Comments Added

Added completion comments to:
- Peony #38 (SNES Graphics Extractor) - Already complete
- Peony #39 (GBA Graphics Extractor) - Completed session 07
- Poppy #130 (Text Encoder) - Completed this session

## Commits

### Peony Repository
1. `feat: Add table templates for Zelda, Metroid, Castlevania, and Mega Man` (149 insertions)

### Poppy Repository
1. `feat: Add text-encode CLI command with templates (Pokemon, Dragon Quest, Final Fantasy, EarthBound) (#130)` (363 insertions)
2. `feat: Add encoder templates for Zelda, Metroid, Castlevania, and Mega Man` (128 insertions)

## Test Results

- **Peony:** 511+ tests passing
- **Poppy:** 1603 tests passing

## Usage Examples

### Peony (Extraction/Decoding)
```bash
# Generate table from template
peony tbl --template zelda
peony tbl --template megaman -o megaman.tbl

# Extract text using template
peony text rom.nes --table megaman.tbl --offset 0x8000
```

### Poppy (Encoding/Insertion)
```bash
# Encode text for insertion
poppy text-encode --template zelda --text "IT IS DANGEROUS" -o msg.bin
poppy text-encode --template castlevania --text "GAME OVER" --format asm

# With DTE compression
poppy text-encode --table game.tbl --dte dte.tbl -i dialog.txt -o output.bin
```

## Available Templates

| Template | Peony (Decode) | Poppy (Encode) |
|----------|----------------|----------------|
| ASCII | ✅ | ✅ |
| Pokemon | ✅ | ✅ |
| Dragon Quest/Warrior | ✅ | ✅ |
| Final Fantasy | ✅ | ✅ |
| Shift-JIS | ✅ | - |
| EarthBound/Mother | ✅ | ✅ |
| Zelda | ✅ | ✅ |
| Metroid | ✅ | ✅ |
| Castlevania | ✅ | ✅ |
| Mega Man | ✅ | ✅ |

## What's Next

1. **Close GitHub issues** - #38, #39, #130 ready to close
2. **JSON to ASM converter (Poppy #128)** - Generate assembly from JSON data
3. **Shift-JIS encoder for Poppy** - Add Japanese text support
4. **More SNES templates** - Chrono Trigger, Secret of Mana, etc.
5. **Template documentation** - Document all control codes per game

## Related Issues

- Peony #38: SNES Graphics Extractor - **Already Complete** (commented)
- Peony #39: GBA Graphics Extractor - **Complete** (commented)
- Poppy #130: Text Encoder - **Complete** (commented)
- Poppy #128: JSON to ASM - Open
- Poppy #127: Asset Reinsertion EPIC - Ongoing
